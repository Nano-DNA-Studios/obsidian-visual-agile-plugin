name: Publish

on:
  release:
    types: [published]  
  
permissions:
  contents: write
  packages: write

jobs:
  setup:
    runs-on: ["self-hosted", "run-${{github.run_id}}"]
    steps:
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Clone and Checkout the Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true

      - name: Install NPM Packages
        run: npm install
        shell: bash

  version:
    runs-on: ["self-hosted", "run-${{github.run_id}}"]
    needs: setup
    outputs:
      version: ${{ steps.get-tag-version.outputs.version }}

    steps:
      - name: Get Tag Version
        id: get-tag-version
        shell: bash
        run: |
          tagName="${{ github.event.release.tag_name }}"
          version="${tagName#v}"  # Removes the 'v' prefix if it exists
          echo "Extracted version $version from tag"
          echo "version=$version" >> "$GITHUB_OUTPUT"

  build-plugin:
    runs-on: ["self-hosted", "run-${{github.run_id}}"]
    needs: setup
    steps:
      - name: Build the Plugin
        shell: bash
        run: npm run build

  upload-plugin:
    runs-on: ["self-hosted", "run-${{github.run_id}}"]
    needs: [version, build-plugin]
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Copy Manifest 
        run: cp manifest.json dist/manifest.json
        shell: bash
    
      - name: Check File is Made
        shell: bash
        run: ls ./dist

      - name: Upload Manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest.json
          path: ./dist/manifest.json
          retention-days: 1

      - name: Upload Main.js
        uses: actions/upload-artifact@v4
        with:
          name: main.js
          path: ./dist/main.js
          retention-days: 1

      - name: Upload Main.css
        uses: actions/upload-artifact@v4
        with:
          name: main.css
          path: ./dist/main.css
          retention-days: 1

      - name: Upload main.js
        run: gh release upload "${{ github.event.release.tag_name }}" ./dist/main.js --repo ${{ github.repository }} --clobber

      - name: Upload manifest.json
        run: gh release upload "${{ github.event.release.tag_name }}" ./dist/manifest.json --repo ${{ github.repository }} --clobber

      - name: Upload main.css (if exists)
        run: gh release upload "${{ github.event.release.tag_name }}" ./dist/main.css --repo ${{ github.repository }} --clobber